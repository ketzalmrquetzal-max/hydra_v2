<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydra V2 ‚Äî Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --border: #e5e7eb;
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --accent: #2563eb;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-page);
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Sidebar - Dark */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 240px;
            background: #0f172a;
            border-right: 1px solid #1e293b;
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid #1e293b;
            font-weight: 600;
            font-size: 18px;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav { padding: 16px 12px; flex: 1; }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 6px;
            color: #94a3b8;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 4px;
            transition: all 0.15s;
            cursor: pointer;
        }

        .nav-item:hover { background: #1e293b; color: #ffffff; }
        .nav-item.active { background: #1e293b; color: #ffffff; font-weight: 500; }

        .nav-section {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 16px 12px 8px;
        }

        .sidebar-footer {
            padding: 16px 24px;
            border-top: 1px solid #1e293b;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #10b981;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Sound Toggle */
        .sound-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 12px;
            color: #64748b;
        }

        .sound-toggle input { cursor: pointer; }

        /* Main Content */
        .main {
            margin-left: 240px;
            min-height: 100vh;
        }

        /* Top Bar */
        .topbar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 12px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .page-title { font-size: 18px; font-weight: 600; }

        .price-ticker {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-page);
            border-radius: 6px;
            font-size: 14px;
        }

        .price-ticker .symbol { color: var(--text-muted); }
        .price-ticker .price { font-weight: 600; }
        .price-ticker .change { font-size: 12px; }
        .price-ticker .change.up { color: var(--success); }
        .price-ticker .change.down { color: var(--danger); }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .last-update {
            font-size: 12px;
            color: var(--text-muted);
        }

        .btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            transition: all 0.15s;
        }

        .btn:hover { background: var(--bg-page); }

        .badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-blue { background: #dbeafe; color: #1d4ed8; }
        .badge-green { background: #dcfce7; color: #166534; }

        /* Content */
        .content { padding: 24px 32px; }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            transition: all 0.2s;
        }

        .stat-card.flash-buy {
            animation: flashGreen 0.5s ease;
        }

        .stat-card.flash-sell {
            animation: flashRed 0.5s ease;
        }

        @keyframes flashGreen {
            0%, 100% { background: var(--bg-card); }
            50% { background: #dcfce7; border-color: var(--success); }
        }

        @keyframes flashRed {
            0%, 100% { background: var(--bg-card); }
            50% { background: #fee2e2; border-color: var(--danger); }
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-change { font-size: 12px; margin-top: 2px; }
        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* Grid */
        .sections-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .section-header {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title { font-size: 13px; font-weight: 600; }
        .section-body { padding: 16px 20px; }

        /* Chart */
        .chart-section {
            grid-column: 1 / -1;
            height: 380px;
        }

        .chart-section .section-body {
            padding: 0;
            height: calc(100% - 49px);
        }

        /* Brain Section */
        .brain-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brain-action {
            font-size: 28px;
            font-weight: 700;
            transition: all 0.3s;
        }

        .brain-action.hold { color: var(--text-muted); }
        .brain-action.buy { color: var(--success); }
        .brain-action.sell { color: var(--danger); }

        .brain-reason {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 6px;
            max-width: 280px;
        }

        .confidence-display { text-align: center; }

        .confidence-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent);
        }

        .confidence-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Decision History */
        .decision-history {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .decision-chip {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .decision-chip.hold { background: #f3f4f6; color: #6b7280; }
        .decision-chip.buy { background: #dcfce7; color: #166534; }
        .decision-chip.sell { background: #fee2e2; color: #991b1b; }

        /* Sparkline */
        .sparkline-container {
            margin-top: 12px;
            height: 40px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }

        .sparkline-bar {
            flex: 1;
            background: var(--accent);
            border-radius: 2px;
            min-height: 4px;
            opacity: 0.7;
            transition: all 0.3s;
        }

        .sparkline-bar:last-child { opacity: 1; }

        /* Module Status */
        .module-list { display: flex; flex-direction: column; gap: 8px; }

        .module-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .module-item:last-child { border-bottom: none; }
        .module-name { font-size: 13px; font-weight: 500; }

        .module-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--success);
        }

        /* Activity */
        .activity-list { max-height: 200px; overflow-y: auto; }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .activity-item:last-child { border-bottom: none; }
        .activity-time { color: var(--text-muted); font-size: 11px; min-width: 45px; }
        .activity-message { color: var(--text-secondary); }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .main { margin-left: 0; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .sections-grid { grid-template-columns: 1fr; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>

    <!-- Notification Sound -->
    <audio id="notifySound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">üêâ Hydra V2</div>
        
        <nav class="nav">
            <div class="nav-section">Principal</div>
            <a class="nav-item active">üìä Dashboard</a>
            <a class="nav-item">üìà Mercado</a>
            <a class="nav-item">üíº Portafolio</a>
            
            <div class="nav-section">Sistema</div>
            <a class="nav-item">üß† Balam AI</a>
            <a class="nav-item">üõ°Ô∏è Guardian</a>
            <a class="nav-item">‚öôÔ∏è Configuraci√≥n</a>
        </nav>

        <div class="sidebar-footer">
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span>Sistema Activo</span>
            </div>
            <div class="sound-toggle">
                <input type="checkbox" id="soundEnabled">
                <label for="soundEnabled">üîî Alertas sonoras</label>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main class="main">
        
        <!-- Top Bar -->
        <header class="topbar">
            <div class="topbar-left">
                <h1 class="page-title">Dashboard</h1>
                <div class="price-ticker">
                    <span class="symbol">BTC</span>
                    <span class="price" id="btcPrice">$0.00</span>
                    <span class="change up" id="btcChange">+0.0%</span>
                </div>
            </div>
            <div class="topbar-right">
                <span class="last-update" id="lastUpdate">Actualizando...</span>
                <button class="btn" onclick="update()">‚Üª Refresh</button>
                <span class="badge badge-blue" id="systemMode">Simulaci√≥n</span>
            </div>
        </header>

        <!-- Content -->
        <div class="content">

            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-card" id="balanceCard">
                    <div class="stat-label">Balance Total</div>
                    <div class="stat-value" id="totalBalance">$0.00</div>
                    <div class="stat-change positive" id="pnlDaily">+0.0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">USDT Disponible</div>
                    <div class="stat-value" id="usdtFree">$0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Valor en BTC</div>
                    <div class="stat-value" id="btcValue">$0.00</div>
                </div>
                <div class="stat-card" id="actionCard">
                    <div class="stat-label">Decisi√≥n Actual</div>
                    <div class="stat-value" id="currentAction">HOLD</div>
                </div>
            </div>

            <!-- Sections -->
            <div class="sections-grid">

                <!-- Brain -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">üß† An√°lisis de Balam</span>
                    </div>
                    <div class="section-body">
                        <div class="brain-display">
                            <div>
                                <div class="brain-action hold" id="lastAction">HOLD</div>
                                <div class="brain-reason" id="lastReason">Esperando an√°lisis...</div>
                            </div>
                            <div class="confidence-display">
                                <div class="confidence-value" id="confidenceScore">0%</div>
                                <div class="confidence-label">Confianza</div>
                                <div class="sparkline-container" id="sparkline"></div>
                            </div>
                        </div>
                        <div class="decision-history" id="decisionHistory">
                            <span style="font-size: 11px; color: var(--text-muted);">Historial:</span>
                        </div>
                    </div>
                </div>

                <!-- Modules -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">‚ö° Estado del Sistema</span>
                    </div>
                    <div class="section-body">
                        <div class="module-list">
                            <div class="module-item">
                                <span class="module-name">Sentinel</span>
                                <span class="module-status"><span class="status-dot"></span> Activo</span>
                            </div>
                            <div class="module-item">
                                <span class="module-name">Balam AI</span>
                                <span class="module-status"><span class="status-dot"></span> Analizando</span>
                            </div>
                            <div class="module-item">
                                <span class="module-name">Guardian</span>
                                <span class="module-status"><span class="status-dot"></span> Vigilando</span>
                            </div>
                            <div class="module-item">
                                <span class="module-name">Telegram</span>
                                <span class="module-status"><span class="status-dot"></span> Conectado</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="section chart-section">
                    <div class="section-header">
                        <span class="section-title">üìà BTC/USDT ‚Äî Binance</span>
                    </div>
                    <div class="section-body">
                        <div id="tradingview_chart" style="height:100%;width:100%"></div>
                        <script src="https://s3.tradingview.com/tv.js"></script>
                        <script>
                            new TradingView.widget({
                                "autosize": true,
                                "symbol": "BINANCE:BTCUSDT",
                                "interval": "60",
                                "timezone": "America/Mexico_City",
                                "theme": "light",
                                "style": "1",
                                "locale": "es",
                                "toolbar_bg": "#ffffff",
                                "enable_publishing": false,
                                "allow_symbol_change": true,
                                "container_id": "tradingview_chart"
                            });
                        </script>
                    </div>
                </div>

                <!-- Activity -->
                <div class="section" style="grid-column: 1 / -1;">
                    <div class="section-header">
                        <span class="section-title">üìù Actividad Reciente</span>
                    </div>
                    <div class="section-body">
                        <div class="activity-list" id="logConsole">
                            <div class="activity-item">
                                <span class="activity-time">Ahora</span>
                                <span class="activity-message">Dashboard iniciado</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        const API = window.location.origin;
        let lastAction = 'HOLD';
        let decisionHistory = [];
        let confidenceHistory = [];
        let lastUpdateTime = Date.now();

        async function update() {
            try {
                const [wallet, brain] = await Promise.all([
                    fetch(`${API}/api/wallet`).then(r => r.json()),
                    fetch(`${API}/api/brain`).then(r => r.json())
                ]);

                // Update wallet
                document.getElementById('totalBalance').innerText = `$${wallet.balance_total.toFixed(2)}`;
                document.getElementById('usdtFree').innerText = `$${wallet.usdt_free.toFixed(2)}`;
                document.getElementById('btcValue').innerText = `$${wallet.btc_value.toFixed(2)}`;
                document.getElementById('systemMode').innerText = wallet.mode;

                const pnl = document.getElementById('pnlDaily');
                pnl.innerText = wallet.pnl_daily;
                pnl.className = `stat-change ${wallet.pnl_daily.startsWith('+') ? 'positive' : 'negative'}`;

                // Update brain
                const action = brain.action;
                const actionEl = document.getElementById('lastAction');
                actionEl.innerText = action;
                actionEl.className = `brain-action ${action.toLowerCase()}`;
                
                document.getElementById('currentAction').innerText = action;
                document.getElementById('lastReason').innerText = brain.reason;
                document.getElementById('confidenceScore').innerText = `${brain.confidence}%`;

                // Flash animation on action change
                if (action !== lastAction && (action === 'BUY' || action === 'SELL')) {
                    const card = document.getElementById('actionCard');
                    card.classList.add(action === 'BUY' ? 'flash-buy' : 'flash-sell');
                    setTimeout(() => card.classList.remove('flash-buy', 'flash-sell'), 500);

                    // Sound notification
                    if (document.getElementById('soundEnabled').checked) {
                        document.getElementById('notifySound').play().catch(() => {});
                    }
                }

                // Update decision history
                if (action !== lastAction || decisionHistory.length === 0) {
                    decisionHistory.unshift(action);
                    if (decisionHistory.length > 5) decisionHistory.pop();
                    updateDecisionHistory();
                }

                lastAction = action;

                // Update confidence sparkline
                confidenceHistory.push(brain.confidence);
                if (confidenceHistory.length > 10) confidenceHistory.shift();
                updateSparkline();

                // Update timestamp
                lastUpdateTime = Date.now();
                addLog(`${action} ‚Äî ${brain.confidence}% confianza`);

            } catch (e) {
                addLog('Error de conexi√≥n');
            }
        }

        function updateDecisionHistory() {
            const container = document.getElementById('decisionHistory');
            container.innerHTML = '<span style="font-size: 11px; color: var(--text-muted);">Historial:</span>';
            decisionHistory.forEach(d => {
                const chip = document.createElement('span');
                chip.className = `decision-chip ${d.toLowerCase()}`;
                chip.innerText = d;
                container.appendChild(chip);
            });
        }

        function updateSparkline() {
            const container = document.getElementById('sparkline');
            container.innerHTML = '';
            const max = Math.max(...confidenceHistory, 1);
            confidenceHistory.forEach(c => {
                const bar = document.createElement('div');
                bar.className = 'sparkline-bar';
                bar.style.height = `${(c / max) * 100}%`;
                container.appendChild(bar);
            });
        }

        function updateLastUpdate() {
            const seconds = Math.floor((Date.now() - lastUpdateTime) / 1000);
            document.getElementById('lastUpdate').innerText = 
                seconds < 5 ? 'Actualizado ahora' : `Hace ${seconds}s`;
        }

        function addLog(msg) {
            const list = document.getElementById('logConsole');
            const time = new Date().toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `<span class="activity-time">${time}</span><span class="activity-message">${msg}</span>`;
            list.insertBefore(item, list.firstChild);
            while (list.children.length > 20) list.removeChild(list.lastChild);
        }

        // Fetch BTC price
        async function fetchBTCPrice() {
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');
                const data = await res.json();
                document.getElementById('btcPrice').innerText = `$${parseFloat(data.lastPrice).toLocaleString()}`;
                const change = parseFloat(data.priceChangePercent);
                const changeEl = document.getElementById('btcChange');
                changeEl.innerText = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                changeEl.className = `change ${change >= 0 ? 'up' : 'down'}`;
            } catch (e) {}
        }

        // Init
        update();
        fetchBTCPrice();
        setInterval(update, 5000);
        setInterval(fetchBTCPrice, 10000);
        setInterval(updateLastUpdate, 1000);
    </script>

</body>
</html>